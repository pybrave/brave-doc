"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([["3007"],{2169:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>i,default:()=>m,toc:()=>d,metadata:()=>s,assets:()=>r,contentTitle:()=>l});var s=JSON.parse('{"id":"tutorial-basics/software","title":"\u8F6F\u4EF6","description":"\u8F6F\u4EF6\u811A\u672C","source":"@site/docs/tutorial-basics/software.md","sourceDirName":"tutorial-basics","slug":"/tutorial-basics/software","permalink":"/doc/en/docs/tutorial-basics/software","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/tutorial-basics/software.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"\u8F6F\u4EF6"},"sidebar":"tutorialSidebar","previous":{"title":"\u6D41\u7A0B","permalink":"/doc/en/docs/tutorial-basics/pipeline"},"next":{"title":"\u6587\u4EF6","permalink":"/doc/en/docs/tutorial-basics/file"}}'),o=t(5893),a=t(65);let i={sidebar_position:3,title:"\u8F6F\u4EF6"},l=void 0,r={},d=[{value:"\u8F6F\u4EF6\u811A\u672C",id:"\u8F6F\u4EF6\u811A\u672C",level:2},{value:"\u8F93\u5165\u89E3\u6790\u6A21\u5757",id:"\u8F93\u5165\u89E3\u6790\u6A21\u5757",level:2},{value:"\u8F93\u51FA\u89E3\u6790\u6A21\u5757",id:"\u8F93\u51FA\u89E3\u6790\u6A21\u5757",level:2}];function c(e){let n={code:"code",h2:"h2",li:"li",pre:"pre",ul:"ul",...(0,a.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",metastring:"title='software'",children:'{\n  "name": "\u53BB\u5BBF\u4E3B",\n//   "analysisPipline": "bowtie2_remove_host",\n  // "parseAnalysisModule": "bowtie2_remove_host",\n  "parseAnalysisResultModule": [\n    {\n      "module": "bowtie2_align_unsorted",\n      "dir": "bowtie2_align_host",\n      "analysisMethod": "bowtie2_align_host"\n    },\n    {\n      "module": "samtools_remove_hosts",\n      "dir": "samtools_remove_hosts",\n      "analysisMethod": "samtools_remove_hosts"\n    }\n  ],\n  "upstreamFormJson": [\n    {\n      "name": "genome_index",\n      "dataKey": "host_genome_index",\n      "label": "\u5BBF\u4E3B\u57FA\u56E0\u7EC4",\n      "rules": [\n        {\n          "required": true,\n          "message": "\u8BE5\u5B57\u6BB5\u4E0D\u80FD\u4E3A\u7A7A!"\n        }\n      ],\n      "type": "BaseSelect"\n    }\n  ]\n}\n'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:".\n\u2514\u2500\u2500 software\n    \u2514\u2500\u2500 cc1c6f83-6c5a-4de9-89a4-d12fc58dcda9\n        \u251C\u2500\u2500 bowtie2_align_unsorted.py\n        \u251C\u2500\u2500 main.nf\n        \u251C\u2500\u2500 main.py\n        \u2514\u2500\u2500 samtools_remove_hosts.py\n"})}),"\n",(0,o.jsx)(n.h2,{id:"\u8F6F\u4EF6\u811A\u672C",children:"\u8F6F\u4EF6\u811A\u672C"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["component_id = ",(0,o.jsx)(n.code,{children:"cc1c6f83-6c5a-4de9-89a4-d12fc58dcda9"})," (software component id)"]}),"\n",(0,o.jsxs)(n.li,{children:["module",":software",".",(0,o.jsx)(n.code,{children:"{component_id}"}),".main"]}),"\n",(0,o.jsxs)(n.li,{children:["path:",(0,o.jsx)(n.code,{children:"{pipeline_dir}"}),"/software/",(0,o.jsx)(n.code,{children:"{component_id}"}),"/main.nf"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-nextflow",children:'process bowtie2 {\n    tag "$meta.id"\n    publishDir "output/bowtie2/${meta.id}", mode: \'symlink\', overwrite: true\n\n    input:\n    tuple val(meta),path(reads)\n    val(reference)\n\n    output:\n    tuple val(meta), path("*.{bam,sam}"), emit: aligned, optional:true\n    tuple val(meta), path("*.log")      , emit: log\n    tuple val(meta), path("*fastq.*.gz")  , emit: fastq, optional:true\n\n\n    script:\n    """\n    export PATH=/home/jovyan/.conda/envs/bowtie2/bin:\\$PATH\n    bowtie2 \\\n        -x ${reference} \\\n        -1 ${reads[0]} -2 ${reads[1]} \\\n        --threads ${task.cpus} \\\n        --un-conc  ${meta.id}.unmapped.fastq.gz \\\n        2> >(tee ${meta.id}.bowtie2.log >&2) \\\n        | samtools view --threads $task.cpus -bS -o ${meta.id}.bam\n    """\n\n    stub:\n    """\n    \n    """\n}\nprocess samtools_remove_hosts {\n    publishDir "output/samtools_remove_hosts", mode: \'symlink\', overwrite: true\n\n    input:\n    tuple val(meta),path(bam)\n\n    output:\n    tuple val(meta),path("*.fastq.gz") ,emit:fastq\n\n    script:\n    """\n    export PATH=/home/jovyan/.conda/envs/bowtie2/bin:\\$PATH\n\n    samtools view  \\\n        -@ task.cpus \\\n        -b -f 12 -F 256 \\\n        ${bam} > ${meta.id}_bothReadsUnmapped.bam \n    \n    samtools sort -n  -@ ${task.cpus} \\\n        ${meta.id}_bothReadsUnmapped.bam \\\n         -o ${meta.id}_bothReadsUnmapped_sorted.bam\n\n    samtools fastq -@ ${task.cpus} ${meta.id}_bothReadsUnmapped_sorted.bam \\\n        -1 ${meta.id}_host_removed_R1.fastq.gz \\\n        -2 ${meta.id}_host_removed_R2.fastq.gz \\\n        -0 /dev/null -s /dev/null -n\n\n    """\n\n    stub:\n    """\n    \n    """\n}\nworkflow  {\n    ch_input = channel.fromList(params.samples).map(it->[[id:it.sample_key],[it.fastq1,it.fastq2]])\n    ch_bowtie2_host_index = Channel.value(params.genome_index)\n    ch_bowtie2_res = bowtie2(ch_input, ch_bowtie2_host_index)    \n    ch_samtools_remove_hosts_res = samtools_remove_hosts(ch_bowtie2_res.aligned)\n}\n'})}),"\n",(0,o.jsx)(n.h2,{id:"\u8F93\u5165\u89E3\u6790\u6A21\u5757",children:"\u8F93\u5165\u89E3\u6790\u6A21\u5757"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n    "parseAnalysisModule": "bowtie2_remove_host"\n}\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["component_id = ",(0,o.jsx)(n.code,{children:"32493b81-e61d-4f80-9088-7f939402ca82"})," (software component id)"]}),"\n",(0,o.jsxs)(n.li,{children:["module",":software",".",(0,o.jsx)(n.code,{children:"{component_id}"}),".main"]}),"\n",(0,o.jsxs)(n.li,{children:["path:",(0,o.jsx)(n.code,{children:"{pipeline_dir}"}),"/software/",(0,o.jsx)(n.code,{children:"{component_id}"}),"/main.py"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",metastring:"title='bowtie2_remove_host.py'",children:"import json\nimport pandas as pd \ndef get_data(item):\n    content = item.content \n    return {\n        \"sample_key\":item.sample_key,\n        \"fastq1\":content['fastq1'],\n        \"fastq2\":content['fastq2'],\n    }\n\ndef get_db_field():\n    return ['clean_reads']\n\ndef parse_data(request_param,db_dict):\n    reads = db_dict['clean_reads']\n    samples = [get_data(item) for item in reads]\n    result = {\n        \"samples\":samples,\n        \"genome_index\":request_param['genome_index']\n    }\n    return result\n"})}),"\n",(0,o.jsx)(n.h2,{id:"\u8F93\u51FA\u89E3\u6790\u6A21\u5757",children:"\u8F93\u51FA\u89E3\u6790\u6A21\u5757"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n    "parseAnalysisResultModule": [\n    {\n      "module": "bowtie2_align_unsorted",\n      "dir": "bowtie2_align_host",\n      "analysisMethod": "bowtie2_align_host"\n    },\n    {\n      "module": "samtools_remove_hosts",\n      "dir": "samtools_remove_hosts",\n      "analysisMethod": "samtools_remove_hosts"\n    }\n  ]\n}\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["component_id = ",(0,o.jsx)(n.code,{children:"32493b81-e61d-4f80-9088-7f939402ca82"})," (software component id)"]}),"\n",(0,o.jsxs)(n.li,{children:["module",":software",".",(0,o.jsx)(n.code,{children:"{component_id}"}),".",(0,o.jsx)(n.code,{children:"{parseAnalysisResultModule[0].analysisMethod}"})]}),"\n",(0,o.jsxs)(n.li,{children:["path:",(0,o.jsx)(n.code,{children:"{pipeline_dir}"}),"/software/",(0,o.jsx)(n.code,{children:"{component_id}"}),"/",(0,o.jsx)(n.code,{children:"{parseAnalysisResultModule[0].analysisMethod}"}),".py"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",metastring:"title='bowtie2_align_unsorted.py'",children:'import glob\nimport os\nimport json \n\ndef get_content(file):\n    return json.dumps({\n        "bam":file,\n        "log":file.replace(".bam","")+".bowtie2.log"\n    })\n\ndef parse(dir_path,analysis):\n    file_list = glob.glob(f"{dir_path}/*.bam")\n    result_data = [(os.path.basename(file).replace(".bam",""),"bowtie2","json",get_content(file)) for file in file_list]\n    return result_data\n'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",metastring:"title='samtools_remove_hosts.py'",children:'import glob\nimport os\nimport json\n\ndef get_json(file):\n    return json.dumps({\n        "fastq1":file,\n        "fastq2":file.replace("_host_removed_R1.fastq.gz","_host_removed_R2.fastq.gz")\n    })\n\ndef parse(dir_path,analysis):\n    file_list = glob.glob(f"{dir_path}/*_host_removed_R1.fastq.gz")\n    result_data = [(os.path.basename(file).replace("_host_removed_R1.fastq.gz",""),"samtools","json",get_json(file)) for file in file_list]\n    return result_data\n'})})]})}function m(e={}){let{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},65:function(e,n,t){t.d(n,{Z:()=>l,a:()=>i});var s=t(7294);let o={},a=s.createContext(o);function i(e){let n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);